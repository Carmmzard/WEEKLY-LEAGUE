<!DOCTYPE html>
<html>
<head>
    <title>FAMILY LEAGUE</title>
    <link rel="stylesheet" href="src/league.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Krona+One&family=Readex+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Allerta&display=swap" rel="stylesheet">

</head>
<body>
    <div class="App">
        <h1 class="main-title">WEEKLY LEAGUE</h1>

        <div class="tournament-table">
            <div class="table-header default-header">
                <div class="headeramount1 default-header-place">Место</div>
                <div class="headeramount1 default-header-team">Команда</div>
                <div class="headeramount2 default-header-amount">Общее</div>
            </div>
            
            <div id="teamList">
                <!-- Teams will be inserted here -->
            </div>
        </div>



        <div class="logo-container">
            <img src="src/logo.svg" alt="Majestic Logo" class="logo" crossorigin="anonymous">
        </div>

        <div class="pagination-controls">
            <button class="nav-button" id="prevBtn" onclick="previousPage()">
                <svg viewBox="0 0 24 24">
                    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                </svg>
            </button>
            
            <div class="page-info">
                Страница <span id="currentPage">1</span> из <span id="totalPages">1</span>
            </div>
            
            <button class="nav-button" id="nextBtn" onclick="nextPage()">
                <svg viewBox="0 0 24 24">
                    <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                </svg>
            </button>
        </div>
        
        <div class="page-indicator" id="pageDots">
            <!-- Page dots will be generated here -->
        </div>

        <div class="screenshot-button-container">
            <button onclick="takeScreenshot()">Сделать скриншот текущей страницы</button>
        </div>

        <form id="addForm" class="add-form">
            <input type="text" id="teamName" placeholder="Название" required>
            <input type="number" id="teamAmount" placeholder="Сумма" required>
            <button type="submit">Добавить</button>
            <button type="button" onclick="showBulkAdd()">Массовое добавление</button>
            <button type="button" onclick="clearAllTeams()">Массовое удаление</button>
        </form>

        <div id="bulkAddContainer" class="bulk-add" style="display: none;">
            <textarea id="bulkNames" placeholder="Названия (каждое с новой строки)"></textarea>
            <textarea id="bulkAmounts" placeholder="Суммы (каждая с новой строки)"></textarea>
            <div class="bulk-add-buttons">
                <button onclick="handleBulkAdd()">Добавить команды</button>
                <button onclick="hideBulkAdd()">Отмена</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        let teams = [];
        let currentPage = 1;
        const teamsPerPage = 14;

        // Load teams from localStorage
        function loadTeams() {
            const savedTeams = localStorage.getItem('leagueTeams');
            if (savedTeams) {
                teams = JSON.parse(savedTeams);
                updateTeamList();
            } else {
                updatePagination();
            }
        }

        // Save teams to localStorage
        function saveTeams() {
            localStorage.setItem('leagueTeams', JSON.stringify(teams));
        }

        function updateTeamList() {
            const teamList = document.getElementById('teamList');
            teamList.innerHTML = '';
            
            // Sort teams by amount in descending order
            teams.sort((a, b) => b.amount - a.amount);
            
            // Calculate start and end indices for current page
            const startIndex = (currentPage - 1) * teamsPerPage;
            const endIndex = Math.min(startIndex + teamsPerPage, teams.length);
            
            // Get teams for current page
            const currentPageTeams = teams.slice(startIndex, endIndex);
            
            currentPageTeams.forEach((team, localIndex) => {
                const globalIndex = startIndex + localIndex;
                const teamRow = document.createElement('div');
                teamRow.className = 'family-row';
                
                if (globalIndex < 3) {
                    teamRow.classList.add(`top-${globalIndex + 1}`);
                }

                let placeContent = `<div class="place-column">${globalIndex + 1}</div>`;
                
                if (globalIndex === 0) {
                    placeContent = `<div class="place-column"><img src="src/Top1.svg" alt="1 место" class="place-icon"></div>`;
                } else if (globalIndex === 1) {
                    placeContent = `<div class="place-column"><img src="src/Top2.svg" alt="2 место" class="place-icon"></div>`;
                } else if (globalIndex === 2) {
                    placeContent = `<div class="place-column"><img src="src/Top3.svg" alt="3 место" class="place-icon"></div>`;
                }

                teamRow.innerHTML = `
                    ${placeContent}
                    <div class="family-name">
                        ${team.logo ? `<img src="${team.logo}" alt="${team.name} logo" class="team-logo">` : ''}
                        <span class="team-name-text">${team.name}</span>
                        <input type="file" id="logo-upload-${globalIndex}" class="logo-upload-input" accept="image/*" onchange="uploadLogo(${globalIndex}, this)">
                        <label for="logo-upload-${globalIndex}" class="logo-upload-label">+</label>
                    </div>
                    <div class="amount">${team.amount.toLocaleString()}</div>
                `;
                teamList.appendChild(teamRow);
            });

            updatePagination();
            saveTeams();
        }

        function updatePagination() {
            const totalPages = Math.ceil(teams.length / teamsPerPage);
            const currentPageSpan = document.getElementById('currentPage');
            const totalPagesSpan = document.getElementById('totalPages');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            currentPageSpan.textContent = currentPage;
            totalPagesSpan.textContent = totalPages;
            
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
            
            updatePageDots(totalPages);
        }

        function updatePageDots(totalPages) {
            const pageDotsContainer = document.getElementById('pageDots');
            pageDotsContainer.innerHTML = '';
            
            for (let i = 1; i <= totalPages; i++) {
                const dot = document.createElement('div');
                dot.className = `page-dot ${i === currentPage ? 'active' : ''}`;
                dot.onclick = () => goToPage(i);
                pageDotsContainer.appendChild(dot);
            }
        }

        function goToPage(page) {
            if (page >= 1 && page <= Math.ceil(teams.length / teamsPerPage)) {
                currentPage = page;
                updateTeamList();
            }
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                updateTeamList();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(teams.length / teamsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                updateTeamList();
            }
        }

        function updateNewAmount(index, value) {
            teams[index].newAmount = value;
            saveTeams();
        }

        function uploadLogo(index, input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    teams[index].logo = e.target.result;
                    updateTeamList();
                    saveTeams();
                };
                reader.readAsDataURL(file);
            }
        }

        document.getElementById('addForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('teamName').value;
            const amount = parseInt(document.getElementById('teamAmount').value);
            
            if (name && amount) {
                teams.push({ 
                    name, 
                    amount,
                });
                
                // Go to last page if adding new team
                const totalPages = Math.ceil(teams.length / teamsPerPage);
                if (currentPage !== totalPages) {
                    currentPage = totalPages;
                }
                
                updateTeamList();
                saveTeams();
                
                // Clear inputs
                document.getElementById('teamName').value = '';
                document.getElementById('teamAmount').value = '';
            }
        });

        function showBulkAdd() {
            document.getElementById('bulkAddContainer').style.display = 'flex';
            document.getElementById('addForm').style.display = 'none';
        }

        function hideBulkAdd() {
            document.getElementById('bulkAddContainer').style.display = 'none';
            document.getElementById('addForm').style.display = 'flex';
        }

        function handleBulkAdd() {
            const names = document.getElementById('bulkNames').value.split('\n').filter(n => n.trim());
            const amounts = document.getElementById('bulkAmounts').value.split('\n').filter(a => a.trim());
            
            names.forEach((name, index) => {
                if (name && amounts[index]) {
                    teams.push({
                        name: name.trim(),
                        amount: parseInt(amounts[index]) || 0,
                    });
                }
            });
            
            // Go to last page after bulk add
            const totalPages = Math.ceil(teams.length / teamsPerPage);
            currentPage = totalPages;
            
            updateTeamList();
            saveTeams();
            hideBulkAdd();
            
            // Clear bulk inputs
            document.getElementById('bulkNames').value = '';
            document.getElementById('bulkAmounts').value = '';
        }

        function clearAllTeams() {
            if (confirm('Вы уверены, что хотите удалить все команды?')) {
                teams = [];
                currentPage = 1;
                updateTeamList();
                saveTeams();
            }
        }

        async function takeScreenshot() {
            const element = document.querySelector('.App');
            try {
                // Wait for logo to load
                await new Promise((resolve) => {
                    const img = element.querySelector('.logo');
                    if (img.complete) {
                        resolve();
                    } else {
                        img.onload = resolve;
                    }
                });

                const canvas = await html2canvas(element, {
                    backgroundColor: '#121212',
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    ignoreElements: (element) => {
                        return element.className === 'add-form' ||
                               element.className === 'bulk-add' ||
                               element.className === 'screenshot-button-container' ||
                               element.className === 'logo-upload-label' ||
                               element.className === 'pagination-controls' ||
                               element.className === 'page-indicator';
                    }
                });

                canvas.toBlob(async (blob) => {
                    try {
                        await navigator.clipboard.write([
                            new ClipboardItem({
                                'image/png': blob
                            })
                        ]);
                        alert(`Скриншот страницы ${currentPage} сделан, можно добавлять!`);
                    } catch (err) {
                        console.error('Ошибка при копировании в буфер обмена:', err);
                        alert('Не удалось скопировать скриншот в буфер обмена');
                    }
                }, 'image/png');
            } catch (err) {
                console.error('Ошибка при создании скриншота:', err);
                alert('Не удалось создать скриншот');
            }
        }

        // Load teams when page loads
        document.addEventListener('DOMContentLoaded', loadTeams);
    </script>
</body>
</html> 
